
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Management Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        /* Modern CSS Variables */
        :root {
            --primary-color: #6366f1;
            --primary-hover: #5855eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
        }

        /* Global Styles */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Modern Sidebar */
        .sidebar {
            height: 100vh;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #334155 100%);
            color: white;
            position: sticky;
            top: 0;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }

        .sidebar .nav-link {
            color: #cbd5e1;
            border-radius: var(--radius-md);
            margin: 0.25rem 0;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(4px);
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-md);
        }

        /* Modern Cards */
        .card {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            background: white;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-primary);
            padding: 1.25rem 1.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Modern Buttons */
        .btn {
            border-radius: var(--radius-md);
            font-weight: 500;
            padding: 0.625rem 1.25rem;
            transition: all 0.2s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        }

        .btn-outline-secondary {
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        /* Modern Form Controls */
        .form-control, .form-select {
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* Certificate Canvas */
        .certificate-canvas {
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            box-shadow: var(--shadow-md);
        }

        .text-box {
            position: absolute;
            border: 2px dashed var(--primary-color);
            cursor: move;
            background-color: rgba(99, 102, 241, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .text-box:hover {
            background-color: rgba(99, 102, 241, 0.15);
            transform: scale(1.02);
        }

        .text-box.selected {
            border: 3px solid var(--primary-color);
            background-color: rgba(99, 102, 241, 0.2);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .text-label {
            pointer-events: none;
            font-size: 12px;
            font-weight: 500;
            color: var(--primary-color);
        }

        /* Controls */
        .controls {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .certificate-preview {
            max-width: 100%;
            max-height: 70vh;
            border-radius: var(--radius-md);
        }

        /* Modern Tables */
        .table {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table thead th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: none;
            font-weight: 600;
            color: var(--text-primary);
            padding: 1rem;
        }

        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.05);
        }

        /* Pagination */
        .pagination {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            display: flex;
            justify-content: center;
            gap: 0.25rem;
        }

        .pagination .page-item .page-link {
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pagination .page-item .page-link:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        /* Template Fields */
        .template-field {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(99, 102, 241, 0.1) 100%);
            padding: 1rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .custom-field {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.1) 100%);
            padding: 1rem;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--success-color);
            margin-bottom: 1rem;
        }

        /* Alerts */
        .alert {
            border-radius: var(--radius-md);
            border: none;
            box-shadow: var(--shadow-sm);
            font-weight: 500;
        }

        /* Modals */
        .modal-content {
            border-radius: var(--radius-lg);
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid var(--border-color);
        }

        /* Progress Bar */
        .progress {
            border-radius: var(--radius-md);
            background-color: var(--border-color);
            height: 0.75rem;
        }

        .progress-bar {
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                height: auto;
                position: relative;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Smooth Transitions */
        .tab-pane {
            transition: opacity 0.3s ease;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <div class="d-flex flex-column flex-shrink-0 p-4">
                    <a href="/"
                        class="d-flex align-items-center mb-4 mb-md-0 me-md-auto text-white text-decoration-none">
                        <div class="bg-white bg-opacity-10 p-2 rounded me-3">
                            <i class="fas fa-certificate text-white"></i>
                        </div>
                        <div>
                            <span class="fs-5 fw-bold">Certificate</span>
                            <div class="fs-6 text-white-50">Admin Panel</div>
                        </div>
                    </a>
                    <hr class="border-white border-opacity-25">
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item mb-2">
                            <a href="#" class="nav-link active" aria-current="page" data-bs-toggle="tab"
                                data-bs-target="#templates">
                                <i class="fas fa-certificate me-3"></i>
                                <span class="fw-medium">Templates</span>
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a href="#" class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#certificates">
                                <i class="fas fa-list me-3"></i>
                                <span class="fw-medium">Certificates</span>
                            </a>
                        </li>
                        <li class="nav-item mb-2">
                            <a href="#" class="nav-link text-white" data-bs-toggle="tab" data-bs-target="#bulk-upload">
                                <i class="fas fa-upload me-3"></i>
                                <span class="fw-medium">Bulk Upload</span>
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Status Indicator -->
                    <div class="mt-auto pt-4">
                        <div class="d-flex align-items-center text-white-50">
                            <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                            <small>Connected to Firebase</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-0">
                <div class="tab-content" id="nav-tabContent">
                    <!-- Certificate Templates Tab -->
                    <div class="tab-pane fade show active" id="templates">
                        <div class="container-fluid">
                            <div class="row p-4">
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-primary bg-opacity-10 p-3 rounded me-3">
                                            <i class="fas fa-certificate text-primary fs-4"></i>
                                        </div>
                                        <div>
                                            <h2 class="mb-1 fw-bold">Certificate Templates</h2>
                                            <p class="text-muted mb-0">Design and manage your certificate templates</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            Template Settings
                                        </div>
                                        <div class="card-body">
                                            <form id="template-form">
                                                <div class="mb-3">
                                                    <label for="certificateId" class="form-label">Certificate ID</label>
                                                    <input type="text" class="form-control" id="certificateId"
                                                        placeholder="e.g., arts_par">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="certificateImage" class="form-label">Certificate Image
                                                        URL</label>
                                                    <input type="text" class="form-control" id="certificateImage">
                                                    <div class="mt-2">
                                                        <label for="certificateImageFile" class="form-label">Or upload
                                                            image</label>
                                                        <input class="form-control" type="file"
                                                            id="certificateImageFile" accept="image/*">
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Page Orientation</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="orientation"
                                                            id="landscape" value="l" checked>
                                                        <label class="form-check-label" for="landscape">
                                                            Landscape
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="orientation"
                                                            id="portrait" value="p">
                                                        <label class="form-check-label" for="portrait">
                                                            Portrait
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="d-grid gap-3">
                                                    <button type="button" class="btn btn-primary btn-lg" id="saveTemplate">
                                                        <i class="fas fa-save me-2"></i>Save Template
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                        id="loadTemplate">
                                                        <i class="fas fa-folder-open me-2"></i>Load Template
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <div class="card mt-3">
                                        <div class="card-header">
                                            Text Box Settings
                                        </div>
                                        <div class="card-body">
                                            <form id="textbox-form">
                                                <div class="mb-3">
                                                    <label for="fieldName" class="form-label">Field Name</label>
                                                    <input type="text" class="form-control" id="fieldName"
                                                        placeholder="e.g., POS, STUDENT_NAME">
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-6">
                                                        <label for="fontSize" class="form-label">Font Size</label>
                                                        <input type="number" class="form-control" id="fontSize"
                                                            value="12">
                                                    </div>
                                                    <div class="col-6">
                                                        <label for="fontStyle" class="form-label">Font Style</label>
                                                        <select class="form-select" id="fontStyle">
                                                            <option value="0">Poppins</option>
                                                            <option value="1">Script</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="mb-3 text-center">
                                                    <button type="button" class="btn btn-success me-2" id="addTextBox">
                                                        <i class="fas fa-plus me-2"></i>Add Text Box
                                                    </button>
                                                    <button type="button" class="btn btn-danger"
                                                        id="removeTextBox">
                                                        <i class="fas fa-trash me-2"></i>Remove Selected
                                                    </button>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Position & Size</label>
                                                    <div class="row g-2">
                                                        <div class="col-6">
                                                            <label for="leftPos" class="form-label">Left (px)</label>
                                                            <input type="number" class="form-control" id="leftPos">
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="topPos" class="form-label">Top (px)</label>
                                                            <input type="number" class="form-control" id="topPos">
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="width" class="form-label">Width (px)</label>
                                                            <input type="number" class="form-control" id="width">
                                                        </div>
                                                        <div class="col-6">
                                                            <label for="height" class="form-label">Height (px)</label>
                                                            <input type="number" class="form-control" id="height">
                                                        </div>
                                                    </div>
                                                    <div id="percentDisplay" class="mt-2">
                                                        <small class="text-muted">Drag text box to see percentage position</small>
                                                    </div>
                                                </div>
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-primary"
                                                        id="updateTextBox">
                                                        <i class="fas fa-edit me-2"></i>Update Text Box
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            Certificate Designer
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="controls p-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-outline-secondary"
                                                            id="zoomIn" title="Zoom In">
                                                            <i class="fas fa-search-plus"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary"
                                                            id="zoomOut" title="Zoom Out">
                                                            <i class="fas fa-search-minus"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary"
                                                            id="resetZoom" title="Reset Zoom">
                                                            <i class="fas fa-sync"></i>
                                                        </button>
                                                    </div>
                                                    <div class="text-muted small">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Drag text boxes to position them on the certificate
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="certificate-container text-center p-3">
                                                <div class="certificate-canvas mx-auto">
                                                    <img id="certificateImg" class="certificate-preview" src=""
                                                        alt="Certificate Template">
                                                    <!-- Text boxes will be added here dynamically -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mt-3">
                                        <div class="card-header">
                                            Text Boxes
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Field</th>
                                                            <th>Font Size</th>
                                                            <th>Font Style</th>
                                                            <th>Position</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="textBoxesTable">
                                                        <!-- Text boxes list will be added here dynamically -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certificate List Tab -->
                    <div class="tab-pane fade" id="certificates">
                        <div class="container-fluid">
                            <div class="row p-4">
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-success bg-opacity-10 p-3 rounded me-3">
                                            <i class="fas fa-list text-success fs-4"></i>
                                        </div>
                                        <div>
                                            <h2 class="mb-1 fw-bold">Certificate List</h2>
                                            <p class="text-muted mb-0">View and manage all certificates</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            Add/Edit Certificate
                                        </div>
                                        <div class="card-body">
                                            <form id="certificate-form">
                                                <div class="mb-3">
                                                    <label for="certificate_id" class="form-label">Certificate Template
                                                        *</label>
                                                    <select class="form-control" id="certificate_id" required>
                                                        <option value="">Select Certificate Template</option>
                                                        <!-- Template options will be populated dynamically -->
                                                    </select>
                                                    <small class="text-muted">Select a template to automatically load
                                                        its fields</small>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="event_name" class="form-label">Event Name *</label>
                                                    <input type="text" class="form-control" id="event_name" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="organizer_name" class="form-label">Organizer Name
                                                        *</label>
                                                    <input type="text" class="form-control" id="organizer_name"
                                                        required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="search_id" class="form-label">Search ID *</label>
                                                    <input type="text" class="form-control" id="search_id" required>
                                                </div>

                                                <!-- Template fields will be added here -->
                                                <div id="template-fields" class="mb-3">
                                                    <!-- Template-specific fields will be added here dynamically -->
                                                </div>

                                                <div id="dynamic-fields">
                                                    <!-- Dynamic fields will be added here -->
                                                </div>

                                                <div class="mb-3">
                                                    <button type="button" class="btn btn-secondary btn-sm"
                                                        id="addField">
                                                        <i class="fas fa-plus"></i> Add Custom Field
                                                    </button>
                                                </div>

                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-primary"
                                                        id="saveCertificate">Save Certificate</button>
                                                    <button type="button" class="btn btn-outline-secondary"
                                                        id="resetForm">Reset Form</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Certificates</span>
                                            <div class="input-group" style="max-width: 300px;">
                                                <input type="text" class="form-control"
                                                    placeholder="Search certificates..." id="certificateSearch">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="searchButton">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Certificate ID</th>
                                                            <th>Event Name</th>
                                                            <th>Organizer</th>
                                                            <th>Search ID</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="certificatesTable">
                                                        <!-- Certificate list will be added here dynamically -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <nav aria-label="Certificate pagination">
                                                <ul class="pagination justify-content-center"
                                                    id="certificatePagination">
                                                    <!-- Pagination will be added here dynamically -->
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Upload Tab -->
                    <div class="tab-pane fade" id="bulk-upload">
                        <div class="container-fluid">
                            <div class="row p-4">
                                <div class="col-12">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="bg-warning bg-opacity-10 p-3 rounded me-3">
                                            <i class="fas fa-upload text-warning fs-4"></i>
                                        </div>
                                        <div>
                                            <h2 class="mb-1 fw-bold">Bulk Certificate Upload</h2>
                                            <p class="text-muted mb-0">Upload multiple certificates via Excel</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Upload Excel File
                                        </div>
                                        <div class="card-body">
                                            <form id="bulk-upload-form">
                                                <div class="mb-3">
                                                    <label for="certificateIdBulk" class="form-label">Certificate
                                                        Template *</label>
                                                    <select class="form-control" id="certificateIdBulk" required>
                                                        <option value="">Select Certificate Template</option>
                                                        <!-- Template options will be populated dynamically -->
                                                    </select>
                                                    <small class="text-muted">Select the template to use for all
                                                        certificates in this batch</small>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="excelFile" class="form-label">Select Excel File
                                                        *</label>
                                                    <input class="form-control" type="file" id="excelFile"
                                                        accept=".xlsx, .xls">
                                                    <small class="text-muted">The Excel file should have columns
                                                        matching the field names in the template</small>
                                                </div>
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-primary" id="uploadBulk">Upload
                                                        & Process</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <div class="card mt-3">
                                        <div class="card-header">
                                            Template Guide
                                        </div>
                                        <div class="card-body">
                                            <p>Your Excel file should contain the following columns:</p>
                                            <ul>
                                                <li><strong>event_name</strong> - The name of the event</li>
                                                <li><strong>organizer_name</strong> - The name of the organizer</li>
                                                <li><strong>search_id</strong> - A unique identifier for searching</li>
                                                <li>Any additional fields that match the text boxes defined in your
                                                    template</li>
                                            </ul>
                                            <p>Download a sample template:</p>
                                            <button type="button" class="btn btn-outline-primary" id="downloadTemplate">
                                                <i class="fas fa-download"></i> Download Sample Template
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Upload Progress
                                        </div>
                                        <div class="card-body">
                                            <div class="progress mb-3" id="uploadProgressContainer"
                                                style="height: 25px; display: none;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                    id="uploadProgress" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <div id="uploadStatus">
                                                <p class="text-center text-muted">No upload in progress</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mt-3">
                                        <div class="card-header">
                                            Preview & Validation
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm" id="previewTable">
                                                    <thead>
                                                        <!-- Preview headers will be added here dynamically -->
                                                    </thead>
                                                    <tbody>
                                                        <!-- Preview data will be added here dynamically -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="validationErrors">
                                                <!-- Validation errors will be added here dynamically -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for certificate template selection -->
    <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalLabel">Select Certificate Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="templateGallery">
                        <!-- Templates will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for certificate details -->
    <div class="modal fade" id="certificateDetailsModal" tabindex="-1" aria-labelledby="certificateDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="certificateDetailsModalLabel">Certificate Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="certificateDetails">
                        <!-- Certificate details will be added here dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Field template preview modal -->
    <div class="modal fade" id="fieldPreviewModal" tabindex="-1" aria-labelledby="fieldPreviewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fieldPreviewModalLabel">Template Fields Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="fieldPreviewContent">
                        <!-- Field preview will be added here dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate Link Modal -->
    <div class="modal fade" id="certificateLinkModal" tabindex="-1" aria-labelledby="certificateLinkModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="certificateLinkModalLabel">Certificate Download Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Certificate Details</label>
                        <div id="certificateLinkDetails" class="card p-3 bg-light">
                            <!-- Certificate details will be shown here -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="certificateLink" class="form-label">Download Link</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="certificateLink" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <small class="text-muted">Share this link with the certificate recipient</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="testLinkBtn">
                        <i class="fas fa-external-link-alt"></i> Test Link
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert container for notifications -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
        <div id="alertContainer"></div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <!-- SheetJS (xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Main JavaScript -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAHrvhT6GKehlEcxMx5IKGp9kKuyDimHbU",
            authDomain: "athlos-25.firebaseapp.com",
            projectId: "athlos-25",
            storageBucket: "athlos-25.firebasestorage.app",
            messagingSenderId: "1040745981700",
            appId: "1:1040745981700:web:94c1b7d8fe52da723ad251",
            measurementId: "G-S4TMQLBL2N"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let currentZoom = 1;
        let selectedTextBox = null;
        let textBoxes = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalCertificates = 0;
        let certificatesData = [];
        let isDragging = false;

        // DOM Elements
        const certificateImg = document.getElementById('certificateImg');
        const canvasElement = document.querySelector('.certificate-canvas');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Initializing application...');
            console.log('Firebase config:', firebaseConfig);
            
            // Test Firebase connection
            testFirebaseConnection();
            
            // Load certificate templates
            loadCertificateTemplates();

            // Load certificates list
            loadCertificates();

            // Setup event listeners
            setupEventListeners();

            // Load template options for dropdowns
            loadCertificateTemplateOptions();
        });

        // Test Firebase connection
        function testFirebaseConnection() {
            console.log('Testing Firebase connection...');
            db.collection('test').doc('connection-test').get()
                .then(() => {
                    console.log('Firebase connection successful');
                })
                .catch(error => {
                    console.error('Firebase connection test failed:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    if (error.code === 'permission-denied') {
                        showAlert('Firebase connection failed: Permission denied. Please check your security rules.', 'danger');
                    } else if (error.code === 'unavailable') {
                        showAlert('Firebase connection failed: Service unavailable. Please check your internet connection.', 'danger');
                    } else {
                        showAlert('Firebase connection failed: ' + error.message, 'danger');
                    }
                });
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Template tab event listeners
            document.getElementById('saveTemplate').addEventListener('click', saveTemplate);
            document.getElementById('loadTemplate').addEventListener('click', () => {
                const templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
                loadTemplateGallery();
                templateModal.show();
            });
            document.getElementById('addTextBox').addEventListener('click', addTextBox);
            document.getElementById('removeTextBox').addEventListener('click', removeSelectedTextBox);
            document.getElementById('updateTextBox').addEventListener('click', updateSelectedTextBox);

            // Zoom controls
            document.getElementById('zoomIn').addEventListener('click', () => adjustZoom(0.1));
            document.getElementById('zoomOut').addEventListener('click', () => adjustZoom(-0.1));
            document.getElementById('resetZoom').addEventListener('click', () => {
                currentZoom = 1;
                updateZoom();
            });

            // Certificate image upload
            document.getElementById('certificateImageFile').addEventListener('change', handleImageUpload);

            // Certificate list tab event listeners
            document.getElementById('saveCertificate').addEventListener('click', saveCertificate);
            document.getElementById('resetForm').addEventListener('click', resetCertificateForm);
            document.getElementById('addField').addEventListener('click', () => addCustomField());
            document.getElementById('searchButton').addEventListener('click', searchCertificates);
            document.getElementById('certificateSearch').addEventListener('keyup', function (event) {
                if (event.key === 'Enter') {
                    searchCertificates();
                }
            });

            // Certificate ID selection event listener
            document.getElementById('certificate_id').addEventListener('change', loadTemplateFields);

            // Bulk upload certificate ID selection
            document.getElementById('certificateIdBulk').addEventListener('change', loadTemplateFieldsPreview);

            // Bulk upload tab event listeners
            document.getElementById('excelFile').addEventListener('change', handleExcelUpload);
            document.getElementById('uploadBulk').addEventListener('click', processBulkUpload);
            document.getElementById('downloadTemplate').addEventListener('click', downloadSampleTemplate);

            // Certificate link modal event listeners
            document.getElementById('copyLinkBtn').addEventListener('click', copyCertificateLink);
            document.getElementById('testLinkBtn').addEventListener('click', testCertificateLink);
        }

        // Load certificate template options for dropdowns
        function loadCertificateTemplateOptions() {
            const certificateIdSelect = document.getElementById('certificate_id');
            const certificateIdBulkSelect = document.getElementById('certificateIdBulk');

            // Clear existing options except the first empty one
            while (certificateIdSelect.options.length > 1) {
                certificateIdSelect.remove(1);
            }

            while (certificateIdBulkSelect.options.length > 1) {
                certificateIdBulkSelect.remove(1);
            }

            // Fetch templates from database
            db.collection('certificate_template').get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        console.log('No certificate templates found');
                    } else {
                        // Add each template as an option to both dropdowns
                        querySnapshot.forEach(doc => {
                            // For certificate_id dropdown
                            const option1 = document.createElement('option');
                            option1.value = doc.id;
                            option1.textContent = doc.id;
                            certificateIdSelect.appendChild(option1);

                            // For certificateIdBulk dropdown
                            const option2 = document.createElement('option');
                            option2.value = doc.id;
                            option2.textContent = doc.id;
                            certificateIdBulkSelect.appendChild(option2);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading template options:', error);
                    showAlert('Error loading template options: ' + error.message, 'danger');
                });
        }

        // Load template fields when a template is selected
        function loadTemplateFields() {
            const templateId = document.getElementById('certificate_id').value;

            // Clear existing template fields
            document.getElementById('template-fields').innerHTML = '';

            if (!templateId) return;

            // Fetch the template's text boxes to create form fields
            db.collection('certificate_template').doc(templateId).collection('tBox').get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        console.log('No fields found for this template');
                        return;
                    }

                    // Add dynamic fields based on the template's text boxes
                    querySnapshot.forEach(doc => {
                        const textBoxData = doc.data();
                        const fieldName = textBoxData.field;

                        // Skip standard fields that are already in the form
                        if (['event_name', 'organizer_name', 'search_id'].includes(fieldName)) {
                            return;
                        }

                        // Add template field with label
                        addTemplateField(fieldName);
                    });

                    showAlert('Template fields loaded', 'success');
                })
                .catch(error => {
                    console.error('Error loading template fields:', error);
                    showAlert('Error loading template fields: ' + error.message, 'danger');
                });
        }

        // Load template fields preview for bulk upload
        function loadTemplateFieldsPreview() {
            const templateId = document.getElementById('certificateIdBulk').value;

            if (!templateId) return;

            // Fetch the template's text boxes to show field preview
            db.collection('certificate_template').doc(templateId).collection('tBox').get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        console.log('No fields found for this template');
                        return;
                    }

                    // Get all field names
                    const fields = [];
                    querySnapshot.forEach(doc => {
                        const textBoxData = doc.data();
                        fields.push(textBoxData.field);
                    });

                    // Show field preview
                    const previewContent = document.getElementById('fieldPreviewContent');

                    // Create preview HTML
                    let previewHTML = '<p>Your Excel file should include these fields:</p>';
                    previewHTML += '<ul class="list-group">';
                    previewHTML += '<li class="list-group-item list-group-item-primary">event_name (required)</li>';
                    previewHTML += '<li class="list-group-item list-group-item-primary">organizer_name (required)</li>';
                    previewHTML += '<li class="list-group-item list-group-item-primary">search_id (required)</li>';

                    fields.forEach(field => {
                        if (!['event_name', 'organizer_name', 'search_id'].includes(field)) {
                            previewHTML += `<li class="list-group-item">${field}</li>`;
                        }
                    });

                    previewHTML += '</ul>';

                    previewContent.innerHTML = previewHTML;

                    // Show the modal
                    const fieldPreviewModal = new bootstrap.Modal(document.getElementById('fieldPreviewModal'));
                    fieldPreviewModal.show();
                })
                .catch(error => {
                    console.error('Error loading template fields preview:', error);
                    showAlert('Error loading template fields preview: ' + error.message, 'danger');
                });
        }

        // Add a template field with label to the form
        function addTemplateField(fieldName, value = '') {
            const templateFields = document.getElementById('template-fields');
            const fieldId = 'template-field-' + fieldName.replace(/\s+/g, '-').toLowerCase();

            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'mb-3 template-field';
            fieldDiv.innerHTML = `
                <label for="${fieldId}" class="form-label">${fieldName}</label>
                <input type="text" class="form-control" id="${fieldId}" data-field-name="${fieldName}" value="${value}">
            `;

            templateFields.appendChild(fieldDiv);
        }

        // Save certificate template - FIXED VERSION
        function saveTemplate() {
            const certificateId = document.getElementById('certificateId').value.trim();
            if (!certificateId) {
                showAlert('Please enter a certificate ID', 'danger');
                return;
            }

            const certificateImage = document.getElementById('certificateImage').value.trim();
            if (!certificateImage && !certificateImg.src) {
                showAlert('Please provide a certificate image URL or upload an image', 'danger');
                return;
            }

            const orientation = document.querySelector('input[name="orientation"]:checked').value;

            // First, delete all existing text boxes in the subcollection
            // This ensures deleted text boxes don't reappear
            db.collection('certificate_template').doc(certificateId).get()
                .then(doc => {
                    if (doc.exists) {
                        // Delete existing subcollection first (all tBox documents)
                        return deleteCollection(
                            db,
                            `certificate_template/${certificateId}/tBox`,
                            100
                        );
                    }
                    return Promise.resolve();
                })
                .then(() => {
                    // Now save the template main document
                    return db.collection('certificate_template').doc(certificateId).set({
                        certificate_image: certificateImage || certificateImg.src,
                        mode: orientation
                    });
                })
                .then(() => {
                    // Then save only the current text boxes as a new subcollection
                    const promises = textBoxes.map(textBox => {
                        return db.collection('certificate_template').doc(certificateId).collection('tBox').add({
                            bottom: textBox.bottom.toString(),
                            top: textBox.top.toString(),
                            right: textBox.right.toString(),
                            left: textBox.left.toString(),
                            height: textBox.height.toString(),
                            width: textBox.width.toString(),
                            style: textBox.style.toString(),
                            font_size: textBox.font_size.toString(),
                            field: textBox.field
                        });
                    });

                    return Promise.all(promises);
                })
                .then(() => {
                    showAlert('Certificate template saved successfully!', 'success');
                    // Refresh template options in dropdowns
                    loadCertificateTemplateOptions();
                })
                .catch(error => {
                    console.error('Error saving template:', error);
                    showAlert('Error saving template: ' + error.message, 'danger');
                });
        }

        // Helper function to delete a Firestore collection
        async function deleteCollection(db, collectionPath, batchSize) {
            const collectionRef = db.collection(collectionPath);
            const query = collectionRef.limit(batchSize);

            return new Promise((resolve, reject) => {
                deleteQueryBatch(db, query, resolve, reject);
            });
        }

        // Helper function to delete documents in batches
        function deleteQueryBatch(db, query, resolve, reject) {
            query.get()
                .then((snapshot) => {
                    // When there are no documents left, we're done
                    if (snapshot.size === 0) {
                        return 0;
                    }

                    // Delete documents in a batch
                    const batch = db.batch();
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });

                    return batch.commit().then(() => {
                        return snapshot.size;
                    });
                })
                .then((numDeleted) => {
                    if (numDeleted === 0) {
                        resolve();
                        return;
                    }

                    // In browser environment, use setTimeout instead of process.nextTick
                    setTimeout(() => {
                        deleteQueryBatch(db, query, resolve, reject);
                    }, 0);
                })
                .catch(reject);
        }

        // Load certificate templates
        function loadCertificateTemplates() {
            console.log('Attempting to load certificate templates...');
            db.collection('certificate_template').get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        console.log('No certificate templates found - this is normal for a new project');
                        showAlert('No certificate templates found. Create your first template!', 'info');
                    } else {
                        console.log(`Found ${querySnapshot.size} certificate templates`);
                    }
                })
                .catch(error => {
                    console.error('Error loading templates:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    // Provide specific error messages based on error type
                    if (error.code === 'permission-denied') {
                        showAlert('Permission denied. Please check your Firebase security rules.', 'danger');
                    } else if (error.code === 'unavailable') {
                        showAlert('Firebase service unavailable. Please try again later.', 'danger');
                    } else {
                        showAlert('Error loading templates: ' + error.message, 'danger');
                    }
                });
        }

        // Load template gallery
        function loadTemplateGallery() {
            const galleryContainer = document.getElementById('templateGallery');
            galleryContainer.innerHTML = '<div class="col-12 text-center"><p>Loading templates...</p></div>';

            console.log('Loading template gallery...');
            db.collection('certificate_template').get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        galleryContainer.innerHTML = `
                            <div class="col-12 text-center">
                                <p>No certificate templates found</p>
                                <p class="text-muted">Create your first template to get started!</p>
                            </div>`;
                    } else {
                        galleryContainer.innerHTML = '';
                        querySnapshot.forEach(doc => {
                            const template = doc.data();
                            const templateElement = document.createElement('div');
                            templateElement.className = 'col-md-4 mb-3';
                            templateElement.innerHTML = `
              <div class="card h-100">
                <img src="${template.certificate_image}" class="card-img-top" alt="Certificate Template" style="height: 150px; object-fit: contain;">
                <div class="card-body">
                  <h5 class="card-title">${doc.id}</h5>
                  <p class="card-text">Orientation: ${template.mode === 'l' ? 'Landscape' : 'Portrait'}</p>
                  <button class="btn btn-primary btn-sm" data-template-id="${doc.id}">Select</button>
                </div>
              </div>
            `;
                            galleryContainer.appendChild(templateElement);

                            // Add event listener to select button
                            templateElement.querySelector('button').addEventListener('click', () => {
                                loadTemplateById(doc.id);
                                bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading template gallery:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    let errorMessage = 'Error loading templates';
                    if (error.code === 'permission-denied') {
                        errorMessage = 'Permission denied. Please check your Firebase security rules.';
                    } else if (error.code === 'unavailable') {
                        errorMessage = 'Firebase service unavailable. Please try again later.';
                    } else {
                        errorMessage = 'Error loading templates: ' + error.message;
                    }
                    
                    galleryContainer.innerHTML = `
                        <div class="col-12 text-center">
                            <p class="text-danger">${errorMessage}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadTemplateGallery()">Retry</button>
                        </div>`;
                });
        }

        // Load template by ID
        function loadTemplateById(templateId) {
            // Clear existing text boxes
            clearTextBoxes();

            // Get template data
            db.collection('certificate_template').doc(templateId).get()
                .then(doc => {
                    if (doc.exists) {
                        const template = doc.data();

                        // Set form values
                        document.getElementById('certificateId').value = templateId;
                        document.getElementById('certificateImage').value = template.certificate_image;
                        certificateImg.src = template.certificate_image;

                        // Set orientation
                        document.getElementById(template.mode === 'l' ? 'landscape' : 'portrait').checked = true;

                        // Load text boxes
                        return db.collection('certificate_template').doc(templateId).collection('tBox').get();
                    } else {
                        showAlert('Template not found', 'danger');
                        throw new Error('Template not found');
                    }
                })
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        const textBoxData = doc.data();
                        createTextBox({
                            top: parseInt(textBoxData.top),
                            left: parseInt(textBoxData.left),
                            width: parseInt(textBoxData.width),
                            height: parseInt(textBoxData.height),
                            right: parseInt(textBoxData.right),
                            bottom: parseInt(textBoxData.bottom),
                            style: parseInt(textBoxData.style),
                            font_size: parseInt(textBoxData.font_size),
                            field: textBoxData.field
                        });
                    });
                    updateTextBoxesTable();
                    showAlert('Template loaded successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    if (error.message !== 'Template not found') {
                        showAlert('Error loading template: ' + error.message, 'danger');
                    }
                });
        }

        // Add a text box to the certificate
        function addTextBox() {
            const fieldName = document.getElementById('fieldName').value.trim();
            if (!fieldName) {
                showAlert('Please enter a field name', 'danger');
                return;
            }

            const fontSize = parseInt(document.getElementById('fontSize').value) || 12;
            const fontStyle = document.getElementById('fontStyle').value;

            // Create text box in the middle of the canvas
            const canvasRect = canvasElement.getBoundingClientRect();
            const textBoxWidth = 150;
            const textBoxHeight = 40;

            createTextBox({
                top: Math.floor(canvasRect.height / 2 - textBoxHeight / 2),
                left: Math.floor(canvasRect.width / 2 - textBoxWidth / 2),
                width: textBoxWidth,
                height: textBoxHeight,
                right: Math.floor(canvasRect.width / 2 + textBoxWidth / 2),
                bottom: Math.floor(canvasRect.height / 2 + textBoxHeight / 2),
                style: parseInt(fontStyle),
                font_size: fontSize,
                field: fieldName
            });

            updateTextBoxesTable();
            showAlert('Text box added', 'success');
        }

        // Enhanced text box creation with precise positioning
        function createTextBox(textBoxData) {
            const textBox = document.createElement('div');
            textBox.className = 'text-box';
            textBox.innerHTML = `<div class="text-label">${textBoxData.field}</div>`;

            // Set position and size
            textBox.style.left = `${textBoxData.left}px`;
            textBox.style.top = `${textBoxData.top}px`;
            textBox.style.width = `${textBoxData.width}px`;
            textBox.style.height = `${textBoxData.height}px`;

            // Set font properties
            textBox.style.fontFamily = textBoxData.style === 1 ? 'cursive' : 'Poppins, sans-serif';
            textBox.style.fontSize = `${textBoxData.font_size}px`;

            // Enhanced visual feedback
            textBox.style.cursor = 'grab';
            textBox.style.transition = 'all 0.2s ease';
            textBox.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';

            // Store data in the element
            textBox.dataset.field = textBoxData.field;
            textBox.dataset.style = textBoxData.style;
            textBox.dataset.fontSize = textBoxData.font_size;

            // Add to canvas
            canvasElement.appendChild(textBox);

            // Make draggable
            makeTextBoxDraggable(textBox);

            // Make selectable
            textBox.addEventListener('click', (e) => {
                e.stopPropagation();
                selectTextBox(textBox);
            });

            // Add hover effects
            textBox.addEventListener('mouseenter', () => {
                if (!isDragging) {
                    textBox.style.transform = 'scale(1.02)';
                    textBox.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                }
            });

            textBox.addEventListener('mouseleave', () => {
                textBox.style.transform = 'scale(1)';
                textBox.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            });

            // Add to textBoxes array
            textBoxes.push(textBoxData);

            return textBox;
        }

        // Enhanced draggable text box with precise positioning
        function makeTextBoxDraggable(textBox) {
            let offsetX, offsetY, isDragging = false;
            let startX, startY;

            textBox.addEventListener('mousedown', (e) => {
                e.preventDefault();
                // Get the initial mouse offset
                const rect = textBox.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                startX = e.clientX;
                startY = e.clientY;
                isDragging = true;

                // Add visual feedback
                textBox.style.cursor = 'grabbing';
                textBox.style.zIndex = '1000';

                // Add the mousemove and mouseup event listeners
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;

                const canvasRect = canvasElement.getBoundingClientRect();
                const img = canvasElement.querySelector('img');
                
                if (!img) return;

                // Get image dimensions
                const imgRect = img.getBoundingClientRect();
                const imgWidth = img.naturalWidth;
                const imgHeight = img.naturalHeight;

                // Calculate position relative to the image
                const x = e.clientX - imgRect.left - offsetX;
                const y = e.clientY - imgRect.top - offsetY;

                // Constrain to image boundaries
                const newX = Math.max(0, Math.min(imgRect.width - textBox.offsetWidth, x));
                const newY = Math.max(0, Math.min(imgRect.height - textBox.offsetHeight, y));

                // Update position
                textBox.style.left = `${newX}px`;
                textBox.style.top = `${newY}px`;

                // Calculate percentage position for precise positioning
                const percentX = (newX / imgRect.width) * 100;
                const percentY = (newY / imgRect.height) * 100;

                // Update form values if this is the selected text box
                if (selectedTextBox === textBox) {
                    document.getElementById('leftPos').value = Math.round(newX);
                    document.getElementById('topPos').value = Math.round(newY);
                    
                    // Show percentage values for precise positioning
                    const percentDisplay = document.getElementById('percentDisplay');
                    if (percentDisplay) {
                        percentDisplay.innerHTML = `
                            <small class="text-muted">
                                Position: ${percentX.toFixed(2)}%  ${percentY.toFixed(2)}%
                            </small>
                        `;
                    }
                }
            }

            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);

                // Reset visual feedback
                textBox.style.cursor = 'grab';
                textBox.style.zIndex = '10';

                // Update the textBoxes array with the new position
                if (selectedTextBox === textBox) {
                    updateTextBoxData();
                }
            }
        }

        // Enhanced text box selection with precise positioning
        function selectTextBox(textBox) {
            // Deselect current selection
            if (selectedTextBox) {
                selectedTextBox.classList.remove('selected');
            }

            // Select new one
            selectedTextBox = textBox;
            textBox.classList.add('selected');

            // Update form values
            const left = parseInt(textBox.style.left);
            const top = parseInt(textBox.style.top);
            const width = parseInt(textBox.style.width);
            const height = parseInt(textBox.style.height);

            document.getElementById('fieldName').value = textBox.dataset.field;
            document.getElementById('fontSize').value = textBox.dataset.fontSize;
            document.getElementById('fontStyle').value = textBox.dataset.style;

            document.getElementById('leftPos').value = left;
            document.getElementById('topPos').value = top;
            document.getElementById('width').value = width;
            document.getElementById('height').value = height;

            // Calculate and display percentage position
            const img = canvasElement.querySelector('img');
            if (img) {
                const imgRect = img.getBoundingClientRect();
                const percentX = (left / imgRect.width) * 100;
                const percentY = (top / imgRect.height) * 100;
                
                const percentDisplay = document.getElementById('percentDisplay');
                if (percentDisplay) {
                    percentDisplay.innerHTML = `
                        <small class="text-muted">
                            Position: ${percentX.toFixed(2)}%  ${percentY.toFixed(2)}%
                        </small>
                    `;
                }
            }

            // Add visual feedback for selected text box
            textBox.style.border = '3px solid var(--primary-color)';
            textBox.style.boxShadow = '0 0 0 3px rgba(99, 102, 241, 0.2)';
        }

        // Update the selected text box
        function updateSelectedTextBox() {
            if (!selectedTextBox) {
                showAlert('Please select a text box first', 'warning');
                return;
            }

            const fieldName = document.getElementById('fieldName').value.trim();
            if (!fieldName) {
                showAlert('Please enter a field name', 'danger');
                return;
            }

            const fontSize = parseInt(document.getElementById('fontSize').value) || 12;
            const fontStyle = document.getElementById('fontStyle').value;
            const left = parseInt(document.getElementById('leftPos').value) || 0;
            const top = parseInt(document.getElementById('topPos').value) || 0;
            const width = parseInt(document.getElementById('width').value) || 150;
            const height = parseInt(document.getElementById('height').value) || 40;

            // Update the DOM element
            selectedTextBox.style.left = `${left}px`;
            selectedTextBox.style.top = `${top}px`;
            selectedTextBox.style.width = `${width}px`;
            selectedTextBox.style.height = `${height}px`;
            selectedTextBox.style.fontFamily = fontStyle === '1' ? 'cursive' : 'Poppins, sans-serif';
            selectedTextBox.style.fontSize = `${fontSize}px`;

            selectedTextBox.dataset.field = fieldName;
            selectedTextBox.dataset.style = fontStyle;
            selectedTextBox.dataset.fontSize = fontSize;

            selectedTextBox.querySelector('.text-label').textContent = fieldName;

            // Update the textBoxes array
            updateTextBoxData();
            updateTextBoxesTable();

            showAlert('Text box updated', 'success');
        }

        // Update text box data in array
        function updateTextBoxData() {
            if (!selectedTextBox) return;

            const index = textBoxes.findIndex(tb => tb.field === selectedTextBox.dataset.field);
            if (index === -1) return;

            const canvasRect = canvasElement.getBoundingClientRect();
            const left = parseInt(selectedTextBox.style.left);
            const top = parseInt(selectedTextBox.style.top);
            const width = parseInt(selectedTextBox.style.width);
            const height = parseInt(selectedTextBox.style.height);

            textBoxes[index] = {
                top: top,
                left: left,
                width: width,
                height: height,
                right: left + width,
                bottom: top + height,
                style: parseInt(selectedTextBox.dataset.style),
                font_size: parseInt(selectedTextBox.dataset.fontSize),
                field: selectedTextBox.dataset.field
            };
        }

        // Remove the selected text box
        function removeSelectedTextBox() {
            if (!selectedTextBox) {
                showAlert('Please select a text box first', 'warning');
                return;
            }

            // Remove from DOM
            selectedTextBox.remove();

            // Remove from array
            const index = textBoxes.findIndex(tb => tb.field === selectedTextBox.dataset.field);
            if (index !== -1) {
                textBoxes.splice(index, 1);
            }

            // Clear selection
            selectedTextBox = null;

            // Update table
            updateTextBoxesTable();

            showAlert('Text box removed', 'success');
        }

        // Clear all text boxes
        function clearTextBoxes() {
            // Remove from DOM
            const textBoxElements = canvasElement.querySelectorAll('.text-box');
            textBoxElements.forEach(el => el.remove());

            // Clear array
            textBoxes = [];
            selectedTextBox = null;

            // Clear form
            document.getElementById('fieldName').value = '';
            document.getElementById('fontSize').value = '12';
            document.getElementById('fontStyle').value = '0';
            document.getElementById('leftPos').value = '';
            document.getElementById('topPos').value = '';
            document.getElementById('width').value = '';
            document.getElementById('height').value = '';

            // Update table
            updateTextBoxesTable();
        }

        // Update the text boxes table
        function updateTextBoxesTable() {
            const tableBody = document.getElementById('textBoxesTable');
            tableBody.innerHTML = '';

            textBoxes.forEach((textBox, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
        <td>${textBox.field}</td>
        <td>${textBox.font_size}px</td>
        <td>${textBox.style === 1 ? 'Script' : 'Poppins'}</td>
        <td>Left: ${textBox.left}, Top: ${textBox.top}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary edit-btn" data-index="${index}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${index}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
                tableBody.appendChild(row);

                // Add event listeners
                row.querySelector('.edit-btn').addEventListener('click', () => {
                    // Find the corresponding DOM element
                    const textBoxElements = canvasElement.querySelectorAll('.text-box');
                    textBoxElements.forEach(el => {
                        if (el.dataset.field === textBox.field) {
                            selectTextBox(el);
                        }
                    });
                });

                row.querySelector('.delete-btn').addEventListener('click', () => {
                    // Find the corresponding DOM element
                    const textBoxElements = canvasElement.querySelectorAll('.text-box');
                    textBoxElements.forEach(el => {
                        if (el.dataset.field === textBox.field) {
                            selectedTextBox = el;
                            removeSelectedTextBox();
                        }
                    });
                });
            });
        }

        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Check if it's an image
            if (!file.type.match('image.*')) {
                showAlert('Please select an image file', 'danger');
                return;
            }

            // Create a local URL for the image (temporary solution)
            const localURL = URL.createObjectURL(file);
            document.getElementById('certificateImage').value = localURL;
            certificateImg.src = localURL;
            showAlert('Image loaded successfully! (Note: This is a local preview. For production, use a web server.)', 'success');
            
            // Uncomment the following code when you have CORS configured or are using a web server
            /*
            // Create a storage reference
            const storageRef = storage.ref(`certificate_templates/${Date.now()}_${file.name}`);

            // Upload the file
            const uploadTask = storageRef.put(file);

            // Listen for state changes
            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progress function
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done');
                },
                (error) => {
                    // Error function
                    console.error('Error uploading image:', error);
                    showAlert('Error uploading image: ' + error.message, 'danger');
                },
                () => {
                    // Complete function
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        console.log('File available at', downloadURL);
                        document.getElementById('certificateImage').value = downloadURL;
                        certificateImg.src = downloadURL;
                        showAlert('Image uploaded successfully!', 'success');
                    });
                }
            );
            */
        }

        // Adjust zoom
        function adjustZoom(delta) {
            currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
            updateZoom();
        }

        // Update zoom
        function updateZoom() {
            canvasElement.style.transform = `scale(${currentZoom})`;
            canvasElement.style.transformOrigin = 'center top';
        }

        // Certificate List Functions

        // Load certificates
        function loadCertificates(search = '') {
            const certificatesTable = document.getElementById('certificatesTable');
            certificatesTable.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="d-flex flex-column align-items-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mb-0">Loading certificates...</p>
                        </div>
                    </td>
                </tr>
            `;

            let query = db.collection('certificate_list');

            if (search) {
                // Implement search - can search by certificate_id, event_name, or search_id
                query = query.where('search_id', '>=', search)
                    .where('search_id', '<=', search + '\uf8ff')
                    .limit(20);
            } else {
                query = query.limit(itemsPerPage);
            }

            query.get()
                .then(querySnapshot => {
                    certificatesData = [];
                    querySnapshot.forEach(doc => {
                        certificatesData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    renderCertificatesTable();

                    // Count total certificates for pagination (only if not searching)
                    if (!search) {
                        db.collection('certificate_list').get().then(snapshot => {
                            totalCertificates = snapshot.size;
                            renderPagination();
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading certificates:', error);
                    certificatesTable.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading certificates: ${error.message}</td></tr>`;
                });
        }

        // Render certificates table
        function renderCertificatesTable() {
            const certificatesTable = document.getElementById('certificatesTable');

            if (certificatesData.length === 0) {
                certificatesTable.innerHTML = '<tr><td colspan="5" class="text-center">No certificates found</td></tr>';
                return;
            }

            certificatesTable.innerHTML = '';

            certificatesData.forEach(cert => {
                const row = document.createElement('tr');
                row.innerHTML = `
        <td>${cert.certificate_id || 'N/A'}</td>
        <td>${cert.event_name || 'N/A'}</td>
        <td>${cert.organizer_name || 'N/A'}</td>
        <td>${cert.search_id || 'N/A'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-btn" data-id="${cert.id}">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary edit-btn" data-id="${cert.id}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-info link-btn" data-id="${cert.id}" title="Generate Download Link">
            <i class="fas fa-link"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${cert.id}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
                certificatesTable.appendChild(row);

                // Add event listeners
                row.querySelector('.view-btn').addEventListener('click', () => viewCertificate(cert.id));
                row.querySelector('.edit-btn').addEventListener('click', () => editCertificate(cert.id));
                row.querySelector('.link-btn').addEventListener('click', () => generateCertificateLink(cert.id));
                row.querySelector('.delete-btn').addEventListener('click', () => deleteCertificate(cert.id));
            });
        }

        // Render pagination
        function renderPagination() {
            const paginationElement = document.getElementById('certificatePagination');
            paginationElement.innerHTML = '';

            const totalPages = Math.ceil(totalCertificates / itemsPerPage);

            if (totalPages <= 1) {
                return;
            }

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
            paginationElement.appendChild(prevLi);

            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    loadCertificatesPage(currentPage);
                }
            });

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                paginationElement.appendChild(pageLi);
                pageLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    loadCertificatesPage(currentPage);
                });
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
            paginationElement.appendChild(nextLi);

            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    loadCertificatesPage(currentPage);
                }
            });
        }

        // Load certificates page
        function loadCertificatesPage(page) {
            const skip = (page - 1) * itemsPerPage;

            db.collection('certificate_list')
                .limit(itemsPerPage)
                .get()
                .then(querySnapshot => {
                    certificatesData = [];
                    querySnapshot.forEach(doc => {
                        certificatesData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });

                    renderCertificatesTable();
                    renderPagination();
                })
                .catch(error => {
                    console.error('Error loading certificates:', error);
                    showAlert('Error loading certificates: ' + error.message, 'danger');
                });
        }

        // View certificate details
        function viewCertificate(id) {
            db.collection('certificate_list').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const cert = doc.data();

                        const detailsContainer = document.getElementById('certificateDetails');

                        let fieldsHtml = '';
                        Object.entries(cert).forEach(([key, value]) => {
                            if (key !== 'certificate_id' && key !== 'event_name' && key !== 'organizer_name' && key !== 'search_id') {
                                fieldsHtml += `
                <tr>
                  <th>${key}</th>
                  <td>${value}</td>
                </tr>
              `;
                            }
                        });

                        detailsContainer.innerHTML = `
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title">${cert.event_name || 'No Event Name'}</h5>
                <h6 class="card-subtitle mb-2 text-muted">Certificate ID: ${cert.certificate_id || 'N/A'}</h6>
                <p class="card-text">Organizer: ${cert.organizer_name || 'N/A'}</p>
                <p class="card-text">Search ID: ${cert.search_id || 'N/A'}</p>
              </div>
            </div>
            
            <h6>Additional Fields</h6>
            <table class="table table-striped">
              <tbody>
                ${fieldsHtml || '<tr><td colspan="2" class="text-center">No additional fields</td></tr>'}
              </tbody>
            </table>
          `;

                        const certificateDetailsModal = new bootstrap.Modal(document.getElementById('certificateDetailsModal'));
                        certificateDetailsModal.show();
                    } else {
                        showAlert('Certificate not found', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading certificate:', error);
                    showAlert('Error loading certificate: ' + error.message, 'danger');
                });
        }

        // Edit certificate - ENHANCED VERSION
        function editCertificate(id) {
            db.collection('certificate_list').doc(id).get()
                .then(doc => {
                    if (doc.exists) {
                        const cert = doc.data();

                        // Set form values
                        document.getElementById('certificate_id').value = cert.certificate_id || '';
                        document.getElementById('event_name').value = cert.event_name || '';
                        document.getElementById('organizer_name').value = cert.organizer_name || '';
                        document.getElementById('search_id').value = cert.search_id || '';

                        // Clear template fields and dynamic fields
                        document.getElementById('template-fields').innerHTML = '';
                        document.getElementById('dynamic-fields').innerHTML = '';

                        // First load the template fields
                        loadTemplateFields();

                        // Then add any other custom fields or update template field values
                        setTimeout(() => {
                            Object.entries(cert).forEach(([key, value]) => {
                                if (key !== 'certificate_id' && key !== 'event_name' && key !== 'organizer_name' && key !== 'search_id') {
                                    // Check if this is a template field
                                    const templateField = document.querySelector(`input[data-field-name="${key}"]`);
                                    if (templateField) {
                                        // Update existing template field
                                        templateField.value = value;
                                    } else {
                                        // Add as custom field
                                        addCustomField(key, value);
                                    }
                                }
                            });
                        }, 500); // Give a small delay for template fields to load

                        // Set data attribute for save button
                        document.getElementById('saveCertificate').dataset.id = id;

                        // Switch to certificate tab
                        const tab = new bootstrap.Tab(document.querySelector('a[data-bs-target="#certificates"]'));
                        tab.show();

                        showAlert('Certificate loaded for editing', 'info');
                    } else {
                        showAlert('Certificate not found', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading certificate:', error);
                    showAlert('Error loading certificate: ' + error.message, 'danger');
                });
        }

        // Delete certificate
        function deleteCertificate(id) {
            if (confirm('Are you sure you want to delete this certificate? This action cannot be undone.')) {
                db.collection('certificate_list').doc(id).delete()
                    .then(() => {
                        showAlert('Certificate deleted successfully', 'success');
                        loadCertificates(); // Reload the list
                    })
                    .catch(error => {
                        console.error('Error deleting certificate:', error);
                        showAlert('Error deleting certificate: ' + error.message, 'danger');
                    });
            }
        }

        // Search certificates
        function searchCertificates() {
            const searchTerm = document.getElementById('certificateSearch').value.trim();

            if (searchTerm) {
                loadCertificates(searchTerm);
            } else {
                showAlert('Please enter a search ID', 'warning');
                // loadCertificates(''); // Show instructions
            }
        }

        // Add custom field to form
        function addCustomField(key = '', value = '') {
            const dynamicFields = document.getElementById('dynamic-fields');
            const fieldId = 'custom-field-' + Date.now();

            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'mb-3 custom-field';
            fieldDiv.innerHTML = `
      <div class="input-group">
        <input type="text" class="form-control field-key" placeholder="Field Name" value="${key}">
        <input type="text" class="form-control field-value" placeholder="Field Value" value="${value}">
        <button class="btn btn-outline-danger remove-field" type="button">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;

            dynamicFields.appendChild(fieldDiv);

            // Add event listener to remove button
            fieldDiv.querySelector('.remove-field').addEventListener('click', () => {
                fieldDiv.remove();
            });
        }

        // Reset certificate form
        function resetCertificateForm() {
            document.getElementById('certificate-form').reset();
            document.getElementById('template-fields').innerHTML = '';
            document.getElementById('dynamic-fields').innerHTML = '';
            document.getElementById('saveCertificate').removeAttribute('data-id');
        }

        // Save certificate - ENHANCED VERSION
        function saveCertificate() {
            const certificateId = document.getElementById('certificate_id').value.trim();
            const eventName = document.getElementById('event_name').value.trim();
            const organizerName = document.getElementById('organizer_name').value.trim();
            const searchId = document.getElementById('search_id').value.trim();

            // Validate required fields
            if (!certificateId || !eventName || !organizerName || !searchId) {
                showAlert('Please fill in all required fields', 'danger');
                return;
            }

            // Get custom fields - include both manual and template fields
            const customFields = {};

            // Get manual custom fields
            document.querySelectorAll('.custom-field').forEach(field => {
                const key = field.querySelector('.field-key').value.trim();
                const value = field.querySelector('.field-value').value.trim();

                if (key && value) {
                    customFields[key] = value;
                }
            });

            // Get template fields
            document.querySelectorAll('.template-field input').forEach(input => {
                const key = input.dataset.fieldName;
                const value = input.value.trim();

                if (key && value) {
                    customFields[key] = value;
                }
            });

            // Prepare certificate data
            const certificateData = {
                certificate_id: certificateId,
                event_name: eventName,
                organizer_name: organizerName,
                search_id: searchId,
                ...customFields
            };

            // Check if editing or creating new
            const editId = document.getElementById('saveCertificate').dataset.id;

            if (editId) {
                // Update existing certificate
                db.collection('certificate_list').doc(editId).update(certificateData)
                    .then(() => {
                        showAlert('Certificate updated successfully', 'success');
                        resetCertificateForm();
                        loadCertificates(); // Reload the list
                    })
                    .catch(error => {
                        console.error('Error updating certificate:', error);
                        showAlert('Error updating certificate: ' + error.message, 'danger');
                    });
            } else {
                // Create new certificate
                db.collection('certificate_list').add(certificateData)
                    .then(() => {
                        showAlert('Certificate added successfully', 'success');
                        resetCertificateForm();
                        loadCertificates(); // Reload the list
                    })
                    .catch(error => {
                        console.error('Error adding certificate:', error);
                        showAlert('Error adding certificate: ' + error.message, 'danger');
                    });
            }
        }

        // Bulk Upload Functions

        // Handle Excel file upload - IMPROVED VERSION
        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Clear preview table
            document.getElementById('previewTable').innerHTML = '';
            document.getElementById('validationErrors').innerHTML = '';

            // Check if it's an Excel file
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showAlert('Please select an Excel file (.xlsx or .xls)', 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {
                        type: 'array',
                        cellDates: true,  // Parse dates
                        cellNF: true,     // Parse number formats
                        cellText: false   // Don't force text
                    });

                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON with proper types
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: true,       // Keep raw values
                        dateNF: 'yyyy-mm-dd'  // Date format string
                    });

                    // Preview the data
                    previewExcelData(jsonData);
                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    showAlert('Error parsing Excel file: ' + error.message, 'danger');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Preview Excel data
        function previewExcelData(data) {
            if (!data || data.length === 0) {
                showAlert('No data found in the Excel file', 'warning');
                return;
            }

            // Get table elements
            const previewTable = document.getElementById('previewTable');
            previewTable.innerHTML = '';

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            previewTable.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');

            // Show only first 5 rows for preview
            const previewData = data.slice(0, 5);

            previewData.forEach(row => {
                const tr = document.createElement('tr');

                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] !== undefined ? row[header].toString() : '';
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            previewTable.appendChild(tbody);

            // Validate data
            validateExcelData(data);
        }

        // Validate Excel data
        function validateExcelData(data) {
            const validationErrors = document.getElementById('validationErrors');
            validationErrors.innerHTML = '';

            let hasErrors = false;
            const errors = [];

            // Check if required columns exist
            const requiredColumns = ['event_name', 'organizer_name', 'search_id'];
            const missingColumns = requiredColumns.filter(col => !data[0] || !Object.keys(data[0]).includes(col));

            if (missingColumns.length > 0) {
                errors.push(`Missing required columns: ${missingColumns.join(', ')}`);
                hasErrors = true;
            }

            // Check for empty required fields
            data.forEach((row, index) => {
                requiredColumns.forEach(col => {
                    if (!row[col]) {
                        errors.push(`Row ${index + 1}: Missing value for ${col}`);
                        hasErrors = true;
                    }
                });
            });

            // Get template ID
            const templateId = document.getElementById('certificateIdBulk').value;

            // Check if a template is selected
            if (!templateId) {
                errors.push(`Please select a certificate template before uploading`);
                hasErrors = true;
            }

            // Show validation results
            if (hasErrors) {
                validationErrors.innerHTML = `
        <div class="alert alert-danger">
          <strong>Validation Errors:</strong>
          <ul>
            ${errors.map(err => `<li>${err}</li>`).join('')}
          </ul>
        </div>
      `;
            } else {
                validationErrors.innerHTML = `
        <div class="alert alert-success">
          <strong>Validation Passed!</strong>
          <p>Found ${data.length} records ready to be uploaded.</p>
        </div>
      `;
            }

            return !hasErrors;
        }

        // Process bulk upload
        function processBulkUpload() {
            const certificateId = document.getElementById('certificateIdBulk').value.trim();
            if (!certificateId) {
                showAlert('Please select a Certificate Template', 'danger');
                return;
            }

            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                showAlert('Please select an Excel file', 'danger');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {
                        type: 'array',
                        cellDates: true,
                        cellNF: true,
                        cellText: false
                    });

                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON with proper types
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: true,
                        dateNF: 'yyyy-mm-dd'
                    });

                    // Validate data
                    if (!validateExcelData(jsonData)) {
                        showAlert('Please fix validation errors before uploading', 'danger');
                        return;
                    }

                    // Start upload
                    uploadBulkData(certificateId, jsonData);
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    showAlert('Error processing Excel file: ' + error.message, 'danger');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Upload bulk data - IMPROVED VERSION
        function uploadBulkData(certificateId, data) {
            // Show progress bar
            const progressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('uploadProgress');
            const statusDiv = document.getElementById('uploadStatus');

            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            statusDiv.innerHTML = '<p class="text-center">Uploading data...</p>';

            // Batch uploads using Firestore batch
            const batches = [];
            const batchSize = 500; // Firestore limit is 500 operations per batch

            for (let i = 0; i < data.length; i += batchSize) {
                const batch = db.batch();
                const chunk = data.slice(i, i + batchSize);

                chunk.forEach(item => {
                    // Prepare certificate data
                    const certificateData = {
                        certificate_id: certificateId,
                        event_name: String(item.event_name || ''),
                        organizer_name: String(item.organizer_name || ''),
                        search_id: String(item.search_id || '')
                    };

                    // Add other fields with proper type conversion
                    Object.keys(item).forEach(key => {
                        if (!['event_name', 'organizer_name', 'search_id'].includes(key)) {
                            const value = item[key];

                            // Handle different data types appropriately
                            if (typeof value === 'number') {
                                certificateData[key] = value;
                            } else if (typeof value === 'boolean') {
                                certificateData[key] = value;
                            } else if (value instanceof Date) {
                                certificateData[key] = value;
                            } else if (value === null || value === undefined) {
                                certificateData[key] = null;
                            } else {
                                // Default to string for other types
                                certificateData[key] = String(value);
                            }
                        }
                    });

                    // Add to batch
                    const docRef = db.collection('certificate_list').doc();
                    batch.set(docRef, certificateData);
                });

                batches.push(batch);
            }

            // Execute batches sequentially
            let completed = 0;
            const totalBatches = batches.length;

            const executeNextBatch = (index) => {
                if (index >= totalBatches) {
                    // All batches completed
                    progressBar.style.width = '100%';
                    statusDiv.innerHTML = `<p class="text-center text-success">Upload completed! ${data.length} certificates added.</p>`;
                    showAlert(`Successfully uploaded ${data.length} certificates`, 'success');
                    return;
                }

                batches[index].commit()
                    .then(() => {
                        completed++;
                        const progress = (completed / totalBatches) * 100;
                        progressBar.style.width = `${progress}%`;
                        statusDiv.innerHTML = `<p class="text-center">Uploading... ${completed} of ${totalBatches} batches (${Math.round(progress)}%)</p>`;

                        // Execute next batch
                        executeNextBatch(index + 1);
                    })
                    .catch(error => {
                        console.error('Error in batch upload:', error);
                        statusDiv.innerHTML = `<p class="text-center text-danger">Error: ${error.message}</p>`;
                        showAlert('Error uploading certificates: ' + error.message, 'danger');
                    });
            };

            // Start the first batch
            executeNextBatch(0);
        }

        // Download sample template
        function downloadSampleTemplate() {
            // Get the selected template ID
            const templateId = document.getElementById('certificateIdBulk').value;

            if (!templateId) {
                showAlert('Please select a template first to download a customized sample', 'warning');

                // Create a generic template without custom fields
                const wb = XLSX.utils.book_new();

                // Create worksheet with generic sample data
                const wsData = [
                    {
                        event_name: 'Annual College Day',
                        organizer_name: 'ABC College',
                        search_id: 'COL001'
                    },
                    {
                        event_name: 'Tech Symposium',
                        organizer_name: 'ABC College',
                        search_id: 'COL002'
                    }
                ];

                const ws = XLSX.utils.json_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Sample Data');
                XLSX.writeFile(wb, 'certificate_template_generic.xlsx');
                return;
            }

            // Fetch the template fields to create a custom sample
            db.collection('certificate_template').doc(templateId).collection('tBox').get()
                .then(querySnapshot => {
                    // Create workbook
                    const wb = XLSX.utils.book_new();

                    // Get all field names
                    const fields = [];
                    querySnapshot.forEach(doc => {
                        const textBoxData = doc.data();
                        if (!['event_name', 'organizer_name', 'search_id'].includes(textBoxData.field)) {
                            fields.push(textBoxData.field);
                        }
                    });

                    // Create sample data with the template's fields
                    const wsData = [
                        {
                            event_name: 'Annual College Day',
                            organizer_name: 'ABC College',
                            search_id: 'COL001'
                        },
                        {
                            event_name: 'Tech Symposium',
                            organizer_name: 'ABC College',
                            search_id: 'COL002'
                        }
                    ];

                    // Add template fields to the sample data
                    wsData.forEach(row => {
                        fields.forEach(field => {
                            row[field] = `Sample ${field}`;
                        });
                    });

                    const ws = XLSX.utils.json_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Sample Data');
                    XLSX.writeFile(wb, `certificate_template_${templateId}.xlsx`);

                    showAlert('Sample template downloaded with custom fields', 'success');
                })
                .catch(error => {
                    console.error('Error generating sample template:', error);
                    showAlert('Error generating sample template: ' + error.message, 'danger');
                });
        }

        // Certificate Link Functions

        // Generate certificate download link
        function generateCertificateLink(certificateId) {
            db.collection('certificate_list').doc(certificateId).get()
                .then(doc => {
                    if (doc.exists) {
                        const cert = doc.data();
                        
                        // Generate the download link
                        const baseUrl = window.location.origin;
                        const downloadUrl = `${baseUrl}/download.html?id=${certificateId}&search_id=${cert.search_id}`;
                        
                        // Show certificate details
                        const detailsContainer = document.getElementById('certificateLinkDetails');
                        detailsContainer.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Event:</strong> ${cert.event_name || 'N/A'}<br>
                                    <strong>Organizer:</strong> ${cert.organizer_name || 'N/A'}<br>
                                    <strong>Search ID:</strong> ${cert.search_id || 'N/A'}
                                </div>
                                <div class="col-md-6">
                                    <strong>Certificate ID:</strong> ${cert.certificate_id || 'N/A'}<br>
                                    <strong>Link ID:</strong> ${certificateId}<br>
                                    <strong>Generated:</strong> ${new Date().toLocaleString()}
                                </div>
                            </div>
                        `;
                        
                        // Set the link in the input field
                        document.getElementById('certificateLink').value = downloadUrl;
                        
                        // Show the modal
                        const linkModal = new bootstrap.Modal(document.getElementById('certificateLinkModal'));
                        linkModal.show();
                        
                        showAlert('Certificate link generated successfully!', 'success');
                    } else {
                        showAlert('Certificate not found', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error generating certificate link:', error);
                    showAlert('Error generating certificate link: ' + error.message, 'danger');
                });
        }



        // Copy certificate link to clipboard
        function copyCertificateLink() {
            const linkInput = document.getElementById('certificateLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                showAlert('Link copied to clipboard!', 'success');
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showAlert('Link copied to clipboard!', 'success');
                }).catch(() => {
                    showAlert('Failed to copy link. Please copy manually.', 'warning');
                });
            }
        }

        // Test certificate link
        function testCertificateLink() {
            const linkInput = document.getElementById('certificateLink');
            const url = linkInput.value;
            
            if (url) {
                window.open(url, '_blank');
            } else {
                showAlert('No link available to test', 'warning');
            }
        }

        // Utility Functions

        // Show alert notification
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');

            const alertId = 'alert-' + Date.now();
            const iconMap = {
                'success': 'fas fa-check-circle',
                'danger': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            const icon = iconMap[type] || 'fas fa-info-circle';
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="${icon} me-2 fs-5"></i>
                        <span class="fw-medium">${message}</span>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            alertContainer.innerHTML += alertHtml;

            // Add entrance animation
            const alertElement = document.getElementById(alertId);
            alertElement.style.transform = 'translateX(100%)';
            alertElement.style.transition = 'transform 0.3s ease';
            
            setTimeout(() => {
                alertElement.style.transform = 'translateX(0)';
            }, 10);

            // Auto dismiss after 5 seconds
            setTimeout(() => {
                if (alertElement) {
                    alertElement.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alertElement) {
                            alertElement.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Additional canvas click handler to deselect text box
        canvasElement.addEventListener('click', function (e) {
            if (e.target === canvasElement) {
                if (selectedTextBox) {
                    selectedTextBox.classList.remove('selected');
                    selectedTextBox = null;
                }
            }
        });
    </script>
</body>

</html>
