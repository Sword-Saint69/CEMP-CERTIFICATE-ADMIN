<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Download - ATHLOS 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #5855eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-bg: #f8fafc;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius-md: 0.5rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .certificate-container {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            max-width: 100%;
            width: 100%;
            margin: 2rem;
            overflow: visible;
        }

        .certificate-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .certificate-content {
            padding: 2rem;
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }

        .error-container {
            text-align: center;
            padding: 3rem;
        }

        .certificate-details {
            background: var(--light-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .detail-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        .download-actions {
            text-align: center;
            margin-top: 2rem;
        }

        .btn {
            border-radius: var(--radius-md);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            transition: all 0.2s ease;
        }

        .certificate-preview {
            max-width: 100%;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin: 1rem 0;
        }

        .verification-badge {
            background: var(--success-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            display: inline-block;
            margin-bottom: 1rem;
        }

        .share-buttons {
            margin-top: 1rem;
        }

        .share-btn {
            margin: 0.25rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .share-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .share-btn.telegram {
            background: #0088cc;
            color: white;
        }

        .share-btn.email {
            background: #EA4335;
            color: white;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
    </style>
</head>

<body>
    <div class="certificate-container">
        <div class="certificate-header">
            <h1><i class="fas fa-certificate me-3"></i>Certificate Download</h1>
            <p class="mb-0">ATHLOS 2025 - College of Engineering and Management Punnapra</p>
        </div>
        
        <div class="certificate-content">
            <div id="loadingState" class="loading-spinner">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4>Loading Certificate...</h4>
                <p class="text-muted">Please wait while we retrieve your certificate</p>
            </div>

            <div id="errorState" class="error-container" style="display: none;">
                <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
                <h4>Certificate Not Found</h4>
                <p id="errorMessage">The certificate you're looking for could not be found.</p>
                <button class="btn btn-primary" onclick="window.history.back()">
                    <i class="fas fa-arrow-left me-2"></i>Go Back
                </button>
            </div>

            <div id="certificateState" style="display: none;">
                <div class="verification-badge">
                    <i class="fas fa-shield-check me-2"></i>Verified Certificate
                </div>

                <div class="certificate-details">
                    <h5><i class="fas fa-info-circle me-2"></i>Certificate Details</h5>
                    <div id="certificateDetails">
                        <!-- Certificate details will be populated here -->
                    </div>
                </div>

                <div class="text-center">
                    <h5 class="mb-3"><i class="fas fa-image me-2"></i>Certificate Preview</h5>
                    <div id="certificatePreview">
                        <!-- Certificate preview will be shown here -->
                    </div>
                </div>

                <div class="download-actions">
                    <button class="btn btn-primary btn-lg" id="downloadBtn">
                        <i class="fas fa-download me-2"></i>Download Certificate
                    </button>
                    <button class="btn btn-success btn-lg" id="printBtn">
                        <i class="fas fa-print me-2"></i>Print Certificate
                    </button>
                    <button class="btn btn-outline-secondary" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Go Back
                    </button>
                </div>

                <div class="share-buttons text-center">
                    <h6 class="mb-2">Share Certificate:</h6>
                    <a href="#" class="share-btn whatsapp" id="whatsappShare">
                        <i class="fab fa-whatsapp me-2"></i>WhatsApp
                    </a>
                    <a href="#" class="share-btn telegram" id="telegramShare">
                        <i class="fab fa-telegram me-2"></i>Telegram
                    </a>
                    <a href="#" class="share-btn email" id="emailShare">
                        <i class="fas fa-envelope me-2"></i>Email
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAHrvhT6GKehlEcxMx5IKGp9kKuyDimHbU",
            authDomain: "athlos-25.firebaseapp.com",
            projectId: "athlos-25",
            storageBucket: "athlos-25.firebasestorage.app",
            messagingSenderId: "1040745981700",
            appId: "1:1040745981700:web:94c1b7d8fe52da723ad251",
            measurementId: "G-S4TMQLBL2N"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let certificateData = null;
        let templateData = null;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const certificateId = urlParams.get('id');
        const searchId = urlParams.get('search_id');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            if (!certificateId && !searchId) {
                showError('No certificate ID or search ID provided.');
                return;
            }

            loadCertificate();
        });

        // Load certificate data
        function loadCertificate() {
            let query;

            if (certificateId) {
                // Load by certificate ID
                query = db.collection('certificate_list').doc(certificateId);
            } else if (searchId) {
                // Load by search ID
                query = db.collection('certificate_list').where('search_id', '==', searchId);
            }

            query.get()
                .then((result) => {
                    if (certificateId) {
                        // Single document query
                        if (result.exists) {
                            certificateData = { id: result.id, ...result.data() };
                            loadTemplateAndRender();
                        } else {
                            showError('Certificate not found.');
                        }
                    } else {
                        // Query snapshot
                        if (!result.empty) {
                            const doc = result.docs[0];
                            certificateData = { id: doc.id, ...doc.data() };
                            loadTemplateAndRender();
                        } else {
                            showError('No certificate found with the provided search ID.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading certificate:', error);
                    showError('Error loading certificate: ' + error.message);
                });
        }

        // Load template and render certificate
        function loadTemplateAndRender() {
            // First get the template
            db.collection('certificate_template').doc(certificateData.certificate_id).get()
                .then(templateDoc => {
                    if (!templateDoc.exists) {
                        showError('Certificate template not found.');
                        return;
                    }

                    templateData = templateDoc.data();
                    
                    // Get text boxes for the template
                    return db.collection('certificate_template').doc(certificateData.certificate_id).collection('tBox').get();
                })
                .then(textBoxesSnapshot => {
                    if (!textBoxesSnapshot) return;

                    const textBoxes = [];
                    textBoxesSnapshot.forEach(doc => {
                        textBoxes.push(doc.data());
                    });

                    renderCertificate(textBoxes);
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    showError('Error loading template: ' + error.message);
                });
        }

        // Render certificate
        function renderCertificate(textBoxes) {
            // Hide loading state
            document.getElementById('loadingState').style.display = 'none';
            
            // Show certificate state
            document.getElementById('certificateState').style.display = 'block';

            // Populate certificate details
            const detailsContainer = document.getElementById('certificateDetails');
            detailsContainer.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Event Name:</span>
                    <span class="detail-value">${certificateData.event_name || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Organizer:</span>
                    <span class="detail-value">${certificateData.organizer_name || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Search ID:</span>
                    <span class="detail-value">${certificateData.search_id || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Certificate ID:</span>
                    <span class="detail-value">${certificateData.certificate_id || 'N/A'}</span>
                </div>
            `;

            // Create certificate preview
            createCertificatePreview(textBoxes);
            
            // Setup share buttons
            setupShareButtons();
        }

        // Create certificate preview
        function createCertificatePreview(textBoxes) {
            const previewContainer = document.getElementById('certificatePreview');
            
            // Create certificate HTML
            const certificateHtml = createCertificateHtml(textBoxes);
            previewContainer.innerHTML = certificateHtml;
            
            // Store reference for download
            window.certificateCanvas = previewContainer.querySelector('.certificate-container');
        }

        // Create certificate HTML
        function createCertificateHtml(textBoxes) {
            const imgSrc = templateData.certificate_image || 'https://via.placeholder.com/1200x800/ffffff/cccccc?text=Certificate+Template';
            
            let certificateHtml = `
                <div class="certificate-container" style="position: relative; width: 100%; max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <img src="${imgSrc}" style="width: 100%; height: auto; display: block;" crossorigin="anonymous">
            `;
            
            // Add text boxes with data
            textBoxes.forEach(textBox => {
                const fieldName = textBox.field;
                let fieldValue = '';
                
                // Get value from certificate data
                if (certificateData[fieldName]) {
                    fieldValue = certificateData[fieldName];
                } else if (fieldName === 'event_name') {
                    fieldValue = certificateData.event_name || '';
                } else if (fieldName === 'organizer_name') {
                    fieldValue = certificateData.organizer_name || '';
                } else if (fieldName === 'search_id') {
                    fieldValue = certificateData.search_id || '';
                } else {
                    fieldValue = `[${fieldName}]`;
                }
                
                const left = parseInt(textBox.left);
                const top = parseInt(textBox.top);
                const width = parseInt(textBox.width);
                const height = parseInt(textBox.height);
                const fontSize = parseInt(textBox.font_size);
                const fontStyle = parseInt(textBox.style);
                
                certificateHtml += `
                    <div style="
                        position: absolute;
                        left: ${left}px;
                        top: ${top}px;
                        width: ${width}px;
                        height: ${height}px;
                        font-family: ${fontStyle === 1 ? 'cursive' : 'Arial, sans-serif'};
                        font-size: ${fontSize}px;
                        color: #1e293b;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                        font-weight: bold;
                        text-shadow: 2px 2px 4px rgba(255,255,255,0.9), 1px 1px 2px rgba(0,0,0,0.3);
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 4px;
                        padding: 4px;
                    ">${fieldValue}</div>
                `;
            });
            
            certificateHtml += '</div>';
            return certificateHtml;
        }

        // Setup share buttons
        function setupShareButtons() {
            const currentUrl = window.location.href;
            const certificateTitle = `${certificateData.event_name} - Certificate`;
            
            // WhatsApp share
            document.getElementById('whatsappShare').href = 
                `https://wa.me/?text=${encodeURIComponent(`${certificateTitle}\n\nDownload your certificate: ${currentUrl}`)}`;
            
            // Telegram share
            document.getElementById('telegramShare').href = 
                `https://t.me/share/url?url=${encodeURIComponent(currentUrl)}&text=${encodeURIComponent(certificateTitle)}`;
            
            // Email share
            document.getElementById('emailShare').href = 
                `mailto:?subject=${encodeURIComponent(certificateTitle)}&body=${encodeURIComponent(`Download your certificate: ${currentUrl}`)}`;
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Download certificate
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (!window.certificateCanvas) {
                alert('Certificate not ready for download.');
                return;
            }

            // Wait for image to load before generating canvas
            const img = window.certificateCanvas.querySelector('img');
            if (img && !img.complete) {
                img.onload = () => generateCertificateImage();
            } else {
                generateCertificateImage();
            }
        });

        // Generate certificate image for download
        function generateCertificateImage() {
            const canvas = window.certificateCanvas;
            const img = canvas.querySelector('img');
            
            if (!img || !img.complete) {
                alert('Please wait for the certificate to load completely before downloading.');
                return;
            }

            // Get the actual image dimensions
            const imgWidth = img.naturalWidth;
            const imgHeight = img.naturalHeight;
            
            // Create a temporary container with actual image dimensions
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            tempContainer.style.width = imgWidth + 'px';
            tempContainer.style.height = imgHeight + 'px';
            tempContainer.style.backgroundColor = '#ffffff';
            tempContainer.style.overflow = 'hidden';
            
            // Clone the certificate content
            const certificateClone = canvas.cloneNode(true);
            certificateClone.style.width = '100%';
            certificateClone.style.height = '100%';
            certificateClone.style.position = 'relative';
            certificateClone.style.overflow = 'hidden';
            
            // Set the image to use actual dimensions
            const clonedImg = certificateClone.querySelector('img');
            if (clonedImg) {
                clonedImg.style.width = '100%';
                clonedImg.style.height = '100%';
                clonedImg.style.objectFit = 'cover';
                clonedImg.style.objectPosition = 'center';
            }
            
            tempContainer.appendChild(certificateClone);
            document.body.appendChild(tempContainer);

            // Generate canvas with actual image dimensions
            html2canvas(tempContainer, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: imgWidth,
                height: imgHeight,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `certificate-${certificateData.search_id || certificateData.id}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                // Clean up
                document.body.removeChild(tempContainer);
            }).catch(error => {
                console.error('Error generating certificate image:', error);
                alert('Error generating certificate image. Please try again.');
                document.body.removeChild(tempContainer);
            });
        }

        // Print certificate
        document.getElementById('printBtn').addEventListener('click', function() {
            if (!window.certificateCanvas) {
                alert('Certificate not ready for printing.');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Certificate - ${certificateData.event_name}</title>
                    <style>
                        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                        .certificate-print { max-width: 800px; margin: 0 auto; }
                        .certificate-content { text-align: center; }
                        @media print {
                            body { padding: 0; }
                            .certificate-print { max-width: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="certificate-print">
                        <div class="certificate-content">
                            ${window.certificateCanvas.outerHTML}
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for content to load before printing
            printWindow.onload = function() {
                printWindow.print();
            };
        });
    </script>
</body>
</html> 