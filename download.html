<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Download</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #5855eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --light-bg: #f8fafc;
            --dark-bg: #1e293b;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius-md: 0.5rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .certificate-container {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            max-width: 800px;
            width: 100%;
            margin: 2rem;
            overflow: hidden;
        }

        .certificate-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .certificate-content {
            padding: 2rem;
        }

        .certificate-preview {
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            max-width: 100%;
            height: auto;
            margin: 1rem 0;
        }

        .btn {
            border-radius: var(--radius-md);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        }

        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .error-container {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .certificate-details {
            background: var(--light-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .certificate-details h5 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .detail-value {
            color: var(--text-primary);
        }

        .download-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .certificate-container {
                margin: 1rem;
            }
            
            .certificate-header {
                padding: 1.5rem;
            }
            
            .certificate-content {
                padding: 1.5rem;
            }
            
            .download-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="certificate-container">
        <div class="certificate-header">
            <h1><i class="fas fa-certificate me-3"></i>Certificate Download</h1>
            <p class="mb-0">Your certificate is ready for download</p>
        </div>
        
        <div class="certificate-content">
            <div id="loadingState" class="loading-spinner">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4>Loading Certificate...</h4>
                <p class="text-muted">Please wait while we retrieve your certificate</p>
            </div>

            <div id="errorState" class="error-container" style="display: none;">
                <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 3rem;"></i>
                <h4>Certificate Not Found</h4>
                <p id="errorMessage">The certificate you're looking for could not be found.</p>
                <button class="btn btn-primary" onclick="window.history.back()">
                    <i class="fas fa-arrow-left me-2"></i>Go Back
                </button>
            </div>

            <div id="certificateState" style="display: none;">
                <div class="certificate-details">
                    <h5><i class="fas fa-info-circle me-2"></i>Certificate Details</h5>
                    <div id="certificateDetails">
                        <!-- Certificate details will be populated here -->
                    </div>
                </div>

                <div class="text-center">
                    <h5 class="mb-3"><i class="fas fa-image me-2"></i>Certificate Preview</h5>
                    <div id="certificatePreview">
                        <!-- Certificate preview will be shown here -->
                    </div>
                </div>

                <div class="download-actions">
                    <button class="btn btn-primary" id="downloadBtn">
                        <i class="fas fa-download me-2"></i>Download Certificate
                    </button>
                    <button class="btn btn-success" id="printBtn">
                        <i class="fas fa-print me-2"></i>Print Certificate
                    </button>
                    <button class="btn btn-outline-secondary" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Firebase configuration - same as your admin panel
        const firebaseConfig = {
            apiKey: "AIzaSyAHrvhT6GKehlEcxMx5IKGp9kKuyDimHbU",
            authDomain: "athlos-25.firebaseapp.com",
            projectId: "athlos-25",
            storageBucket: "athlos-25.firebasestorage.app",
            messagingSenderId: "1040745981700",
            appId: "1:1040745981700:web:94c1b7d8fe52da723ad251",
            measurementId: "G-S4TMQLBL2N"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let certificateData = null;
        let templateData = null;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const certificateId = urlParams.get('id');
        const searchId = urlParams.get('search_id');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            if (!certificateId && !searchId) {
                showError('No certificate ID or search ID provided.');
                return;
            }

            loadCertificate();
        });

        // Load certificate data
        function loadCertificate() {
            let query;

            if (certificateId) {
                // Load by certificate ID
                query = db.collection('certificate_list').doc(certificateId);
            } else if (searchId) {
                // Load by search ID
                query = db.collection('certificate_list').where('search_id', '==', searchId);
            }

            query.get()
                .then((result) => {
                    if (certificateId) {
                        // Single document query
                        if (result.exists) {
                            certificateData = { id: result.id, ...result.data() };
                            loadTemplateAndRender();
                        } else {
                            showError('Certificate not found.');
                        }
                    } else {
                        // Query snapshot
                        if (!result.empty) {
                            const doc = result.docs[0];
                            certificateData = { id: doc.id, ...doc.data() };
                            loadTemplateAndRender();
                        } else {
                            showError('No certificate found with the provided search ID.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading certificate:', error);
                    showError('Error loading certificate: ' + error.message);
                });
        }

        // Load template and render certificate
        function loadTemplateAndRender() {
            if (!certificateData.certificate_id) {
                showError('Certificate template not found.');
                return;
            }

            // Load template data
            db.collection('certificate_template').doc(certificateData.certificate_id).get()
                .then(templateDoc => {
                    if (templateDoc.exists) {
                        templateData = templateDoc.data();
                        
                        // Load template text boxes
                        return db.collection('certificate_template')
                            .doc(certificateData.certificate_id)
                            .collection('tBox')
                            .get();
                    } else {
                        throw new Error('Certificate template not found.');
                    }
                })
                .then(textBoxesSnapshot => {
                    const textBoxes = [];
                    textBoxesSnapshot.forEach(doc => {
                        textBoxes.push(doc.data());
                    });
                    
                    renderCertificate(textBoxes);
                })
                .catch(error => {
                    console.error('Error loading template:', error);
                    showError('Error loading certificate template: ' + error.message);
                });
        }

        // Render the certificate
        function renderCertificate(textBoxes) {
            // Hide loading state
            document.getElementById('loadingState').style.display = 'none';
            
            // Show certificate state
            document.getElementById('certificateState').style.display = 'block';

            // Populate certificate details
            const detailsContainer = document.getElementById('certificateDetails');
            detailsContainer.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Event Name:</span>
                    <span class="detail-value">${certificateData.event_name || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Organizer:</span>
                    <span class="detail-value">${certificateData.organizer_name || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Search ID:</span>
                    <span class="detail-value">${certificateData.search_id || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Certificate ID:</span>
                    <span class="detail-value">${certificateData.certificate_id || 'N/A'}</span>
                </div>
            `;

            // Create certificate preview
            createCertificatePreview(textBoxes);
        }

        // Create certificate preview
        function createCertificatePreview(textBoxes) {
            const previewContainer = document.getElementById('certificatePreview');
            
            if (!templateData.certificate_image) {
                previewContainer.innerHTML = '<p class="text-muted">No certificate image available</p>';
                return;
            }

            // Create certificate canvas with proper dimensions
            const canvas = document.createElement('div');
            canvas.style.position = 'relative';
            canvas.style.width = '100%';
            canvas.style.maxWidth = '800px';
            canvas.style.margin = '0 auto';
            canvas.style.border = '2px solid #e2e8f0';
            canvas.style.borderRadius = '8px';
            canvas.style.overflow = 'hidden';
            canvas.style.backgroundColor = '#ffffff';

            // Create a container for the certificate
            const certificateContainer = document.createElement('div');
            certificateContainer.className = 'certificate-container';
            certificateContainer.style.position = 'relative';
            certificateContainer.style.width = '100%';
            certificateContainer.style.height = 'auto';
            certificateContainer.style.minHeight = '600px'; // Minimum height for certificates
            certificateContainer.style.display = 'inline-block'; // Ensure proper sizing

            // Add certificate background image
            const img = document.createElement('img');
            img.src = templateData.certificate_image;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.maxWidth = '100%';
            img.alt = 'Certificate Background';
            img.onload = function() {
                // After image loads, position text elements correctly
                positionTextElements(canvas, textBoxes, img);
            };
            img.onerror = function() {
                // If image fails to load, show error
                previewContainer.innerHTML = '<p class="text-danger">Error loading certificate background image</p>';
            };

            certificateContainer.appendChild(img);

            // Add text boxes with certificate data
            textBoxes.forEach(textBox => {
                const textDiv = document.createElement('div');
                textDiv.style.position = 'absolute';
                textDiv.style.fontSize = textBox.font_size + 'px';
                textDiv.style.fontFamily = textBox.style === '1' ? 'cursive' : 'Poppins, sans-serif';
                textDiv.style.display = 'flex';
                textDiv.style.alignItems = 'center';
                textDiv.style.justifyContent = 'center';
                textDiv.style.color = '#1e293b';
                textDiv.style.fontWeight = '500';
                textDiv.style.textAlign = 'center';
                textDiv.style.wordWrap = 'break-word';
                textDiv.style.overflow = 'hidden';
                textDiv.style.pointerEvents = 'none'; // Prevent text selection
                textDiv.style.zIndex = '10'; // Ensure text appears above image

                // Get the value for this field
                const fieldValue = certificateData[textBox.field] || textBox.field;
                textDiv.textContent = fieldValue;
                textDiv.setAttribute('data-field', textBox.field);
                textDiv.setAttribute('data-original-left', textBox.left);
                textDiv.setAttribute('data-original-top', textBox.top);
                textDiv.setAttribute('data-original-width', textBox.width);
                textDiv.setAttribute('data-original-height', textBox.height);
                textDiv.setAttribute('data-original-font-size', textBox.font_size);

                // Add a temporary border for debugging (remove in production)
                textDiv.style.border = '1px solid red';
                textDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';

                certificateContainer.appendChild(textDiv);
            });

            canvas.appendChild(certificateContainer);
            previewContainer.appendChild(canvas);

            // Store canvas reference for download/print
            window.certificateCanvas = canvas;
        }

        // Position text elements correctly after image loads
        function positionTextElements(canvas, textBoxes, img) {
            if (!img) return;

            // Wait a bit for the image to fully render
            setTimeout(() => {
                // Get the actual displayed image dimensions
                const imgRect = img.getBoundingClientRect();
                const actualWidth = imgRect.width;
                const actualHeight = imgRect.height;

                console.log('Image dimensions:', actualWidth, 'x', actualHeight);

                // Position each text element using percentage-based positioning
                textBoxes.forEach(textBox => {
                    const textDiv = canvas.querySelector(`div[data-field="${textBox.field}"]`);
                    if (textDiv) {
                        // Get original positions from data attributes
                        const originalLeft = parseInt(textDiv.getAttribute('data-original-left'));
                        const originalTop = parseInt(textDiv.getAttribute('data-original-top'));
                        const originalWidth = parseInt(textDiv.getAttribute('data-original-width'));
                        const originalHeight = parseInt(textDiv.getAttribute('data-original-height'));

                        console.log('Text field:', textBox.field, 'Original pos:', originalLeft, originalTop);

                        // Calculate positions as percentages of the image size
                        const leftPercent = (originalLeft / 800) * 100; // Assuming 800px template width
                        const topPercent = (originalTop / 600) * 100;   // Assuming 600px template height
                        const widthPercent = (originalWidth / 800) * 100;
                        const heightPercent = (originalHeight / 600) * 100;

                        // Apply percentage-based positioning
                        textDiv.style.left = leftPercent + '%';
                        textDiv.style.top = topPercent + '%';
                        textDiv.style.width = widthPercent + '%';
                        textDiv.style.height = heightPercent + '%';

                        // Scale font size based on image width
                        const originalFontSize = parseInt(textDiv.getAttribute('data-original-font-size'));
                        const scaleFactor = actualWidth / 800; // Scale based on width
                        const scaledFontSize = Math.max(originalFontSize * scaleFactor, 8); // Minimum 8px
                        textDiv.style.fontSize = scaledFontSize + 'px';

                        console.log('Positioned:', textBox.field, 'at', leftPercent + '%', topPercent + '%');
                    }
                });
            }, 100); // Small delay to ensure image is fully rendered
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Download certificate
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (!window.certificateCanvas) {
                alert('Certificate not ready for download.');
                return;
            }

            // Wait for image to load before generating canvas
            const img = window.certificateCanvas.querySelector('img');
            if (img && !img.complete) {
                img.onload = () => generateCertificateImage();
            } else {
                generateCertificateImage();
            }
        });

        // Generate certificate image for download
        function generateCertificateImage() {
            const canvas = window.certificateCanvas;
            
            // Create a temporary container for better rendering
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            tempContainer.style.width = '800px'; // Fixed width for consistent rendering
            tempContainer.style.height = '600px'; // Fixed height for consistent rendering
            tempContainer.style.backgroundColor = '#ffffff';
            tempContainer.style.overflow = 'hidden';
            
            // Clone the certificate content
            const certificateClone = canvas.querySelector('.certificate-container').cloneNode(true);
            certificateClone.style.width = '100%';
            certificateClone.style.height = '100%';
            certificateClone.style.position = 'relative';
            
            // Reposition text elements for download (using original template dimensions)
            const textElements = certificateClone.querySelectorAll('[data-field]');
            textElements.forEach(textDiv => {
                const originalLeft = parseInt(textDiv.getAttribute('data-original-left'));
                const originalTop = parseInt(textDiv.getAttribute('data-original-top'));
                const originalWidth = parseInt(textDiv.getAttribute('data-original-width'));
                const originalHeight = parseInt(textDiv.getAttribute('data-original-height'));
                const originalFontSize = parseInt(textDiv.getAttribute('data-original-font-size') || '12');
                
                // Calculate positions as percentages for consistent positioning
                const leftPercent = (originalLeft / 800) * 100;
                const topPercent = (originalTop / 600) * 100;
                const widthPercent = (originalWidth / 800) * 100;
                const heightPercent = (originalHeight / 600) * 100;
                
                // Apply percentage-based positioning for download
                textDiv.style.left = leftPercent + '%';
                textDiv.style.top = topPercent + '%';
                textDiv.style.width = widthPercent + '%';
                textDiv.style.height = heightPercent + '%';
                textDiv.style.fontSize = originalFontSize + 'px';
            });
            
            tempContainer.appendChild(certificateClone);
            document.body.appendChild(tempContainer);

            // Generate canvas with better settings
            html2canvas(tempContainer, {
                scale: 3, // Higher resolution
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: 800,
                height: 600,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `certificate-${certificateData.search_id || certificateData.id}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                // Clean up
                document.body.removeChild(tempContainer);
            }).catch(error => {
                console.error('Error generating certificate image:', error);
                alert('Error generating certificate image. Please try again.');
                document.body.removeChild(tempContainer);
            });
        }

        // Print certificate
        document.getElementById('printBtn').addEventListener('click', function() {
            if (!window.certificateCanvas) {
                alert('Certificate not ready for printing.');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Certificate - ${certificateData.event_name || 'Certificate'}</title>
                        <style>
                            @media print {
                                body { margin: 0; padding: 0; }
                                .certificate-print { 
                                    width: 100%; 
                                    height: 100vh; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;
                                    background: white;
                                }
                                .certificate-content {
                                    max-width: 90%;
                                    max-height: 90vh;
                                    object-fit: contain;
                                }
                            }
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                background: #f5f5f5;
                                font-family: Arial, sans-serif;
                            }
                            .certificate-print {
                                background: white;
                                padding: 20px;
                                border-radius: 8px;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            }
                        </style>
                    </head>
                    <body>
                        <div class="certificate-print">
                            <div class="certificate-content">
                                ${window.certificateCanvas.outerHTML}
                            </div>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for content to load before printing
            printWindow.onload = function() {
                printWindow.print();
            };
        });
    </script>
</body>
</html> 